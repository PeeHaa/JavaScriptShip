var ExtendedMath=Object.create(Math);ExtendedMath.rand=function(b,a){return Math.floor(Math.random()*(a-b+1))+b};function RandomItemGenerator(){this.getRandomItem=function(b){var a=this.generateRandomPool(b);return a[ExtendedMath.rand(0,a.length)]};this.generateRandomPool=function(d){var c=[];for(var b in d){if(!d.hasOwnProperty(b)){continue}for(var a=0;a<d[b];a++){c.push(b)}}return c}}function Settings(){this.persistentConfig=null;this.values={music:{enabled:true,volume:100}};this.initialize=function(){persistentConfig=localStorage.getItem("config");if(persistentConfig===null){this.persist();return this}this.values=this.merge(true,this.values,JSON.parse(persistentConfig));return this};this.merge=function(){var f=arguments[0]||{},d=1,e=arguments.length,a=false,c;if(typeof f==="boolean"){a=f;f=arguments[1]||{};d=2}if(typeof f!=="object"){f={}}if(e==d){f=this;--d}for(;d<e;d++){if((c=arguments[d])!=null){for(var b in c){if(typeof f[b]==="undefined"){continue}var g=f[b],h=c[b];if(f===h){continue}if(a&&h&&typeof h==="object"&&!h.nodeType){f[b]=this.merge(a,g||(h.length!=null?[]:{}),h)}else{if(h!==undefined){f[b]=h}}}}}return f};this.persist=function(){localStorage.setItem("config",JSON.stringify(this.values))}}function Menu(b,d,c,a){this.menuItems={newGame:{name:"New game",enabled:true,active:false,type:"button",click:function(){this.hideMenu();c.newGame()}.bind(this)},music:{name:"Music: {state}",enabled:true,active:false,type:"toggler",states:["off","on"],state:d.values.music.enabled?1:0,click:function(){console.log(this.state);if(this.state===0){this.state=1;d.values.music.enabled=true;a.play()}else{this.state=0;d.values.music.enabled=false;a.stop()}d.persist()}}};this.isActive=false;this.ticker=0;this.showMenu=function(){this.isActive=true;this.drawMenu();this.drawTicker()};this.drawMenu=function(){if(!this.isActive){return}var f=b.createLinearGradient(0,0,0,100);f.addColorStop(0,"#e2e2e2");f.addColorStop(1,"#d1d1d1");b.fillStyle=f;b.fillRect(300,150,200,250);b.lineWidth=1;b.strokeStyle="#ffffff";b.strokeRect(300,150,200,250);var e=0;for(var g in this.menuItems){if(!this.menuItems.hasOwnProperty(g)){continue}var f=b.createLinearGradient(0,0,0,10);f.addColorStop(0,"#e2e2e2");f.addColorStop(1,"#d1d1d1");b.fillStyle=f;b.fillRect(310,(160+(e*30)),180,25);b.lineWidth=3;if(this.menuItems[g].active){b.setLineDash([30,2]);b.lineDashOffset=this.ticker}b.strokeStyle="#ffffff";b.strokeRect(310,(160+(e*30)),180,25);b.setLineDash([]);switch(this.menuItems[g].type){case"button":this.drawButtonContent(this.menuItems[g],e);break;case"toggler":this.drawTogglerContent(this.menuItems[g],e);break}e++}};this.drawButtonContent=function(f,e){b.fillStyle="#ffffff";b.font="bold 16px Verdana";b.fillText(f.name,340,(178+(e*30)))};this.drawTogglerContent=function(f,e){b.fillStyle="#ffffff";b.font="bold 16px Verdana";b.fillText(f.name.replace("{state}",f.states[f.state]),340,(178+(e*30)))};this.hideMenu=function(){this.isActive=false};this.hover=function(g){this.deActivateAll();var f=this.elementInRange(g.x,g.y);if(f!==null){f.active=true}this.drawMenu()};this.deActivateAll=function(){for(var e in this.menuItems){if(!this.menuItems.hasOwnProperty(e)){continue}this.menuItems[e].active=false}};this.click=function(g){var f=this.elementInRange(g.x,g.y);if(f!==null){f.click()}this.drawMenu()};this.elementInRange=function(f,h){var e=0;for(var g in this.menuItems){if(f>=310&&f<=490&&h>=(166+(e*30))&&h<=(197+(e*30))&&this.menuItems[g].enabled){return this.menuItems[g]}e++}return null};this.drawTicker=function(){setTimeout(function(){this.ticker--;this.drawMenu();this.drawTicker()}.bind(this),50)}}function AudioPlayer(a){this.audioPlayer=new Audio("/JShipTheme 3.ogg");this.play=function(){if(!a.values.music.enabled){return this}this.audioPlayer.volume=(a.values.music.volume/100);this.audioPlayer.loop=true;this.audioPlayer.play();return this};this.stop=function(){this.audioPlayer.pause();this.audioPlayer.currentTime=0}}function GameEngine(b){var a=b.getContext("2d");this.settings=new Settings().initialize();this.audioPlayer=new AudioPlayer(this.settings).play();this.menu=new Menu(a,this.settings,this,this.audioPlayer);this.map={};this.currentGame={sector:1,turns:0,view:"map"};this.newGame=function(){this.map=new Map(b,a).generate(this.currentGame.sector)};b.addEventListener("mouseover",function(c){this.hoverAction(c)}.bind(this));b.addEventListener("mousemove",function(c){this.hoverAction(c)}.bind(this));this.hoverAction=function(c){if(this.menu.isActive){this.menu.hover(c);return}if(this.currentGame.view==="map"){this.map.showPositionInfo(c)}};b.addEventListener("click",function(c){if(this.menu.isActive){this.menu.click(c);return}if(this.currentGame.view==="map"){if(this.map.isActiveJumpValid()){this.map.moveToActiveJump();this.turns++}}}.bind(this));document.addEventListener("keyup",function(c){if(c.keyCode!==27){return}if(!this.menu.isActive){if(this.currentGame.view==="map"){this.map.pause()}this.menu.showMenu()}else{if(this.currentGame.view==="map"){this.map.resume()}this.menu.hideMenu()}}.bind(this))}function Map(b,a){this.sector=1;this.position=null;this.jumps=[];this.exitJumpDrawOffset=0;this.drawEnabled=true;this.settings={width:b.width,height:b.height,minJumps:20,maxJumps:30};this.generate=function(c){this.sector=c;this.generateJumps();this.setStartingPosition();this.setExitPosition();this.draw();this.exitSpinner();return this};this.draw=function(){this.addBackground();this.addHeader();this.addPaths();this.addJumps()};this.setStartingPosition=function(){var e=null,h=[];for(var f=0,d=this.jumps.length;f<d;f++){var c=this.jumps[f];if(e===null||c.info.x<e.info.x){e=c}if(c.info.x<=Map.STARTING_POINT_RANGE){h.push(c)}if(h.length===3){break}}if(h.length>0){var g=h[ExtendedMath.rand(0,(h.length-1))]}else{var g=e}g.info.environment=[];g.info.events=[];g.info.ships=[];g.info.hasPlayer=true;this.position=g};this.setExitPosition=function(){var f=null,h=[];for(var g=0,d=this.jumps.length;g<d;g++){var c=this.jumps[g];if(f===null||c.info.x>f.info.x){f=c}if(c.info.x>=(this.settings.width-Map.EXIT_POINT_RANGE)){h.push(c)}if(h.length===3){break}}if(h.length>0){var e=h[ExtendedMath.rand(0,(h.length-1))]}else{var e=f}e.info.isExit=true};this.addBackground=function(){var c=a.createLinearGradient(0,0,0,150);c.addColorStop(0,"#203060");c.addColorStop(1,"#0F153C");a.fillStyle=c;a.fillRect(0,0,this.settings.width,this.settings.height)};this.addHeader=function(c){a.fillStyle="#ffffff";a.font="bold 16px Verdana";a.fillText("JShip v0.2: Sector "+this.sector,10,25)};this.generateJumps=function(){var c=ExtendedMath.rand(this.settings.minJumps,this.settings.maxJumps);for(var d=0;d<c;d++){this.addRandomJump()}};this.addRandomJump=function(){var c=ExtendedMath.rand(Map.MINIMUM_DISTANCE_TO_BORDERS,(this.settings.width-Map.MINIMUM_DISTANCE_TO_BORDERS)),d=ExtendedMath.rand(Map.MINIMUM_DISTANCE_TO_BORDERS,(this.settings.height-Map.MINIMUM_DISTANCE_TO_BORDERS));this.jumps.push(new Jump(c,d))};this.isValidJump=function(c,g){for(var f=0,d=this.jumps.length;f<d;f++){var e=this.jumps[f].info;if(c>(e.x-Map.MINIMUM_DISTANCE_BETWEEN_JUMPS)&&c<(e.x+Map.MINIMUM_DISTANCE_BETWEEN_JUMPS)){return false}if(g>(e.y-Map.MINIMUM_DISTANCE_BETWEEN_JUMPS)&&g<(e.y+Map.MINIMUM_DISTANCE_BETWEEN_JUMPS)){return false}}return true};this.addPaths=function(){this.jumps.forEach(function(c){if(c.info.isActive){this.showPaths(c)}}.bind(this))};this.addJumps=function(){this.jumps.forEach(function(c){this.addJump(c)}.bind(this))};this.addJump=function(c){a.beginPath();a.arc(c.info.x,c.info.y,5,0,2*Math.PI,false);a.fillStyle=c.info.visited?"#e3e3e3":"#ffffff";a.fillStyle=c.info.hasPlayer?"#000000":a.fillStyle;a.fill();a.lineWidth=2;a.strokeStyle=c.info.isActive?"#ffd1e4":"#00d1e4";a.strokeStyle=c.info.visited?"#3e3e3e":a.strokeStyle;if(c.info.isExit){a.setLineDash([3,2]);a.lineDashOffset=this.exitJumpDrawOffset}a.stroke();a.setLineDash([])};this.showPositionInfo=function(c){this.jumps.forEach(function(d){if(d.isInRange(c.x,c.y)){d.info.isActive=true}else{d.info.isActive=false}});this.draw()};this.showPaths=function(c){this.jumps.forEach(function(d){if(d.isInRangeForPath(c.info.x,c.info.y)){this.addPath(c,d)}}.bind(this))};this.addPath=function(d,c){a.beginPath();a.lineWidth=1;a.setLineDash([10,2]);a.strokeStyle="#22ff66";a.moveTo(d.info.x,d.info.y);a.lineTo(c.info.x,c.info.y);a.stroke();a.setLineDash([])};this.isActiveJumpValid=function(){for(var d=0,c=this.jumps.length;d<c;d++){if(!this.jumps[d].info.isActive){continue}return this.position.isInRangeForPath(this.jumps[d].info.x,this.jumps[d].info.y)}return false};this.moveToActiveJump=function(){for(var e=0,d=this.jumps.length;e<d;e++){var c=this.jumps[e];if(c.info.hasPlayer){c.info.visited=true}c.info.hasPlayer=false;if(this.jumps[e].info.isActive){c.info.hasPlayer=true;this.position=c}}this.draw()};this.exitSpinner=function(){setTimeout(function(){if(this.drawEnabled){this.exitJumpDrawOffset++;this.draw()}this.exitSpinner()}.bind(this),50)};this.pause=function(){this.drawEnabled=false};this.resume=function(){this.drawEnabled=true}}Map.MINIMUM_DISTANCE_BETWEEN_JUMPS=30;Map.MINIMUM_DISTANCE_TO_BORDERS=15;Map.STARTING_POINT_RANGE=100;Map.EXIT_POINT_RANGE=100;function Jump(a,b){this.info={x:a,y:b,environment:[],events:[],ships:[],hasPlayer:false,isActive:false,visited:false,isExit:false};this.randomItemGenerator=new RandomItemGenerator();this.initialize=function(){this.setRandomEnvironment();this.setRandomEvent()};this.setRandomEnvironment=function(){this.info.environment.push(this.randomItemGenerator.getRandomItem({normal:15,solar:2,astroid:2}))};this.setRandomEvent=function(){this.info.events.push(this.randomItemGenerator.getRandomItem({none:15}))};this.isInRange=function(c,d){if(c>this.info.x&&c<(this.info.x+15)&&d>this.info.y&&d<(this.info.y+15)){return true}return false};this.isInRangeForPath=function(c,d){if(c>(this.info.x-Jump.MAXIMUM_DISTANCE_FOR_PATH)&&c<(this.info.x+Jump.MAXIMUM_DISTANCE_FOR_PATH)&&d>(this.info.y-Jump.MAXIMUM_DISTANCE_FOR_PATH)&&d<(this.info.y+Jump.MAXIMUM_DISTANCE_FOR_PATH)){return true}return false};this.initialize()}Jump.MAXIMUM_DISTANCE_FOR_PATH=150;